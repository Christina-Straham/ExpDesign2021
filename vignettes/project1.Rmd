---
title: "Project 1 practical sessions"
author: "Tim Triche"
date: "September 27th, 2021"
output: 
  html_document:
    keep_md: true
vignette: >
  %\VignetteIndexEntry{Project1}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
library(devtools)
load_all("./")
```

# Installation
Install the ExpDesign2021 package from github.

```{r eval = FALSE, message = FALSE}
#install.packages("remotes")
#install.packages("BiocManager")
#BiocManager::install("VanAndelInstitute/ExpDesign2021", build_vignettes=TRUE)
```

# Introduction

We'll follow [the tidymodels intro](https://www.tidymodels.org/start/models/), 
but we'll concentrate on the data you (plural) have been generating so far. 

To avoid some annoyance, I wrapped the usual read_sheet and gs4_deauth 
rigamarole in a function called `fetchAssignments` or, explicitly, 
ExpDesign2021::fetchAssignments. (If you want to be super clear about where 
a function should come from, package::function(arguments) is the way to go.)
Let's start by loading the data on the first few weeks' assignments.

```{r eval=TRUE}

# this package
library(ExpDesign2021)

# curious what's in a library?
# try `phelp(library)`, e.g. `phelp(ggthemes)`
# which is short for help(package="ggthemes") 

# grab some data:
assignments <- fetchAssignments() # tada 
# or, equivalently, 
# fetchAssignments() -> assignments 

# verify we got it: 
View(head(assignments)) # the first few rows

# rename the columns for brevity in the following code:
columnNames <- colnames(assignments) # we will re-use this later 
names(columnNames) <- c("timestamp", "ID", "assignment", 
                        "start", "end", "comments") 

# data %>% ("pipe") select columns %>% ("pipe") show the first two lines:
assignments %>% select(c("timestamp", "comments")) %>% head(2) 
# # A tibble: 2 Ã— 2
#   timestamp           comments
#   <dttm>              <chr>
# 1 2021-08-30 10:34:53 I am not actually a student
# 2 2021-09-01 18:39:09 I will likely need to go back and re-read some of these

# The first row comment declares it is from a nonstudent, so drop it. 
# As it turns out, all of the non-bogus entries start the next day. 
# We can take advantage of this to select entries by date on the way in:
library(lubridate)

# remember the vector of names we constructed above?
# Now we will use it "on the fly" to rename columns, 
# en route to filtering out bogus entries,
# adding a column for minutes spent, 
# filtering out negative minutes (!), 
# and assigning the result to `assignments`.
fetchAssignments() %>% 
  rename(columnNames) %>% 
  filter(timestamp > "2021-08-30") %>% 
  mutate(minutes = end - start) %>%
  filter(minutes > 0) -> assignments 

# How many entries remain? 
dim(assignments) 
# [1] 96  7

```

Let's do a bit of exploratory analysis on the tidied assignment data. 


```{r eval=TRUE}

# basic plots
library(ggplot2)

# geom_sina
library(ggforce)

# minimalist themes
library(ggthemes)

# minimalist:
assignments %>% 
  ggplot(aes(x = ID, 
             y = minutes, 
             color = ID)) + 
    geom_sina(show.legend = FALSE) + 
    scale_x_discrete(guide = guide_axis(angle = 60)) + 
    theme_tufte(base_size = 12, 
                base_family = "sans serif") + 
    theme(axis.title.x = element_blank()) + 
    ggtitle("Time spent on assignments by ID") 

```

Let's do a little bit of modeling on the data.
It turns out that both the comments and the assignment names could use work. 
Let's use some natural language processing tools (i.e. big hammers) to fix that.

```{r eval=TRUE}

library(tidytext)


```

That's better.  Now let's plot things again and start fitting some models. 


```{r eval=TRUE}

library(tidymodels)
library(broom.mixed) 

```

# Mixed models

Mixed models attempt to partition variance into `fixed` and `random` 
components, such as a condition (fixed, mean difference) versus a measurement
group (random differences).  This is handy when running replicates, 
particularly if some are technical and some are biological, but there's also 
the possibility of partially pooling some terms.  For now, let's just intro 
some handlers for these types of models.  (These aren't really handled in 
either EDfMB *or* ISLRv2, but they're incredibly useful in actual practice.) 

```{r eval=TRUE}

library(lme4)

# lmer == "linear mixed effects regression"
# kind of an old-school example since parsnip doesn't like mixed models yet
lmm1 <- with(sleepstudy, 
             lmer(Reaction ~ Days + (Days | Subject)))

tidy(lmm1)

# this is fairly traditional 
tidy(lmm1, effects = "fixed")
tidy(lmm1, effects = "fixed", conf.int=TRUE)
tidy(lmm1, effects = "fixed", conf.int=TRUE, conf.method="profile")

# this isn't
tidy(lmm1, effects = "ran_coefs")
tidy(lmm1, effects = "ran_vals", conf.int=TRUE)
tidy(lmm1, effects = "ran_pars", conf.int=TRUE)

```

So, if you visit [the broom.mixed vignette](https://cran.r-project.org/web/packages/broom.mixed/vignettes/broom_mixed_intro.html), you'll find some code to make
a plot of the estimates for various factors in a *different* regression. First, 
adapt that code to the above sleep study. Next we'll start looking at the 
assignments spreadsheet, plotting the data, and fitting models to that. 


# The assignments spreadsheet

Now we're back to what will eventually become project 1.  How about we plot 
some of the columns of the data?

```{r eval=TRUE}

library(sinaplot)
assignments <- fetchAssignments() # tada 

# rename the columns for brevity 
colnames(assignments) <- c("timestamp", "ID", "assignment", 
                           "start", "end", "comments") 

# add a column for "minutes" 
library(lubridate)
assignments %>% mutate(minutes = as.numeric(end - start)) -> assignments

# drop the first two rows
assignments <- assignments[3:nrow(assignments), ] 
assignments$ID <- factor(assignments$ID)

# plot the minutes taken grouped by ID, not super tidy 
with(subset(assignments, minutes > 0), 
     sinaplot(minutes, ID, col=2:7, pch=20))

# only look at assignments which have > 1 entry
assignments$assignment %>% table() %>% sort() %>% tail(9) %>% names() -> ok

# plot the minutes taken grouped by assignment
with(subset(assignments, assignment %in% ok & minutes > 0), 
     sinaplot(minutes, assignment, col=2:7, pch=20))


```

